{% extends "base.html" %}

{% block title %}TimeTracker - Schedule Builder{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-md-8">
        <h1>Schedule Builder</h1>
        <p class="text-muted">
            {{ period.name or "Schedule " + period.start_date.strftime('%Y-%m-%d') }} 
            ({{ period.start_date.strftime('%b %d, %Y') }} to {{ period.end_date.strftime('%b %d, %Y') }})
        </p>
    </div>
    <div class="col-md-4 text-end">
        <div class="btn-group">
            <a href="{{ url_for('schedule_periods') }}" class="btn btn-outline-primary">
                <i class="fas fa-arrow-left"></i> Back to Periods
            </a>
            {% if period.status == 'draft' %}
            <a href="{{ url_for('publish_schedule', period_id=period.id) }}" class="btn btn-success" onclick="return confirm('Are you sure you want to publish this schedule? Once published, it will be visible to all employees.');">
                <i class="fas fa-check"></i> Publish Schedule
            </a>
            {% endif %}
        </div>
    </div>
</div>

{% if period.status == 'published' %}
<div class="row mb-4">
    <div class="col-md-12">
        <div class="alert alert-info">
            <i class="fas fa-info-circle"></i> This schedule has been published. It is now visible to all employees. You can still make changes if needed.
        </div>
    </div>
</div>
{% endif %}

<div class="row">
    <div class="col-md-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">Schedule Calendar</h5>
                <div id="shift-legend" class="d-flex flex-wrap align-items-center">
                    {% for shift in shifts %}
                    <div class="legend-item me-3">
                        <span class="color-swatch" style="background-color: {{ shift.color }}"></span>
                        <span class="ms-1">{{ shift.name }}</span>
                    </div>
                    {% endfor %}
                    <div class="legend-item">
                        <span class="color-swatch" style="background-color: #f8d7da"></span>
                        <span class="ms-1">Time Off</span>
                    </div>
                </div>
            </div>
            <div class="card-body">
                <div class="schedule-grid">
                    <!-- Header row with dates -->
                    <div class="schedule-header">
                        <div class="employee-column">Employee</div>
                        {% for date in dates %}
                        <div class="date-column {% if date.weekday() >= 5 %}weekend{% endif %} {% if date == today %}today{% endif %}">
                            <div class="day-name">{{ date.strftime('%a') }}</div>
                            <div class="date-num">{{ date.strftime('%d') }}</div>
                        </div>
                        {% endfor %}
                    </div>
                    
                    <!-- Employee rows -->
                    {% for employee in employees %}
                    <div class="schedule-row">
                        <div class="employee-column">
                            <div>{{ employee.first_name }} {{ employee.last_name }}</div>
                            <div class="text-muted small">{{ employee.job_title.title if employee.job_title else "" }}</div>
                            <div class="mt-1">
                                <a href="{{ url_for('employee_availability', employee_id=employee.id) }}" class="btn btn-sm btn-outline-secondary" title="Set Availability">
                                    <i class="fas fa-clock"></i>
                                </a>
                            </div>
                        </div>
                        
                        {% for date in dates %}
                        <div class="schedule-cell {% if date.weekday() >= 5 %}weekend{% endif %} {% if date == today %}today{% endif %}"
                             data-employee-id="{{ employee.id }}" 
                             data-date="{{ date.strftime('%Y-%m-%d') }}">
                            
                            <!-- Time off marker -->
                            {% if date.strftime('%Y-%m-%d') in time_off_days and employee.id in time_off_days[date.strftime('%Y-%m-%d')] %}
                            <div class="time-off-marker">Time Off</div>
                            {% else %}
                                <!-- Shift assignments -->
                                {% for assignment in shift_assignments.get(employee.id, []) %}
                                    {% if assignment.date == date %}
                                    {% set shift = shifts|selectattr('id', 'equalto', assignment.shift_id)|first %}
                                    <div class="shift-block" style="background-color: {{ shift.color }}" 
                                         data-assignment-id="{{ assignment.id }}"
                                         data-shift-id="{{ shift.id }}">
                                        <div class="shift-name">{{ shift.name }}</div>
                                        <div class="shift-time">{{ shift.start_time.strftime('%H:%M') }} - {{ shift.end_time.strftime('%H:%M') }}</div>
                                        <div class="shift-actions">
                                            <button type="button" class="btn btn-sm btn-danger remove-shift-btn" title="Remove Shift">
                                                <i class="fas fa-times"></i>
                                            </button>
                                        </div>
                                    </div>
                                    {% endif %}
                                {% endfor %}
                                
                                <!-- Add shift button -->
                                <div class="add-shift-container">
                                    <button type="button" class="btn btn-sm btn-outline-primary add-shift-btn" title="Assign Shift">
                                        <i class="fas fa-plus"></i>
                                    </button>
                                </div>
                            {% endif %}
                        </div>
                        {% endfor %}
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row mt-4">
    <div class="col-md-12">
        <div class="card">
            <div class="card-header">Schedule Insights</div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-4">
                        <div class="card bg-light">
                            <div class="card-body text-center">
                                <h6 class="card-title">Total Shifts</h6>
                                <h3 id="totalShifts">0</h3>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card bg-light">
                            <div class="card-body text-center">
                                <h6 class="card-title">Total Hours</h6>
                                <h3 id="totalHours">0</h3>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card bg-light">
                            <div class="card-body text-center">
                                <h6 class="card-title">Employees Scheduled</h6>
                                <h3 id="employeesScheduled">0</h3>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Assign Shift Modal -->
<div class="modal fade" id="assignShiftModal" tabindex="-1" aria-labelledby="assignShiftModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="assignShiftModalLabel">Assign Shift</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="assignShiftForm">
                    <input type="hidden" id="employee_id" name="employee_id">
                    <input type="hidden" id="date" name="date">
                    
                    <div class="mb-3">
                        <label for="shift_id" class="form-label">Select Shift</label>
                        <select class="form-select" id="shift_id" name="shift_id" required>
                            <option value="">-- Select a Shift --</option>
                            {% for shift in shifts %}
                            <option value="{{ shift.id }}" data-color="{{ shift.color }}">
                                {{ shift.name }} ({{ shift.start_time.strftime('%H:%M') }} - {{ shift.end_time.strftime('%H:%M') }})
                            </option>
                            {% endfor %}
                        </select>
                    </div>
                    
                    <div class="shift-preview mb-3" style="display: none;">
                        <div class="card">
                            <div class="card-body p-2">
                                <div class="preview-shift-block">
                                    <div class="preview-shift-name"></div>
                                    <div class="preview-shift-time"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div id="availabilityInfo" class="alert alert-info" style="display: none;">
                        <i class="fas fa-info-circle"></i> <span id="availabilityMessage"></span>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="saveShiftBtn">Assign Shift</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
    .schedule-grid {
        display: flex;
        flex-direction: column;
        border: 1px solid #dee2e6;
        border-radius: 0.25rem;
        overflow-x: auto;
    }
    
    .schedule-header {
        display: flex;
        background-color: #f8f9fa;
        border-bottom: 1px solid #dee2e6;
        font-weight: bold;
    }
    
    .schedule-row {
        display: flex;
        border-bottom: 1px solid #dee2e6;
    }
    
    .schedule-row:last-child {
        border-bottom: none;
    }
    
    .employee-column {
        min-width: 180px;
        padding: 10px;
        background-color: #f8f9fa;
        border-right: 1px solid #dee2e6;
        position: sticky;
        left: 0;
        z-index: 1;
    }
    
    .date-column {
        flex: 1;
        min-width: 100px;
        text-align: center;
        padding: 5px;
        border-right: 1px solid #dee2e6;
    }
    
    .date-column:last-child {
        border-right: none;
    }
    
    .day-name {
        font-size: 0.8rem;
    }
    
    .date-num {
        font-size: 1.1rem;
    }
    
    .schedule-cell {
        flex: 1;
        min-width: 100px;
        height: 100px;
        padding: 5px;
        border-right: 1px solid #dee2e6;
        position: relative;
    }
    
    .schedule-cell:last-child {
        border-right: none;
    }
    
    .weekend {
        background-color: #f8f9fa;
    }
    
    .today {
        background-color: #e7f5ff;
    }
    
    .shift-block {
        padding: 5px;
        border-radius: 4px;
        margin-bottom: 5px;
        color: white;
        position: relative;
    }
    
    .shift-name {
        font-weight: bold;
        font-size: 0.9rem;
    }
    
    .shift-time {
        font-size: 0.8rem;
    }
    
    .shift-actions {
        position: absolute;
        top: 2px;
        right: 2px;
        display: none;
    }
    
    .shift-block:hover .shift-actions {
        display: block;
    }
    
    .add-shift-container {
        position: absolute;
        bottom: 5px;
        right: 5px;
    }
    
    .time-off-marker {
        background-color: #f8d7da;
        color: #721c24;
        padding: 5px;
        border-radius: 4px;
        text-align: center;
        margin-top: 30px;
    }
    
    .color-swatch {
        display: inline-block;
        width: 15px;
        height: 15px;
        border-radius: 3px;
    }
    
    .legend-item {
        display: flex;
        align-items: center;
        font-size: 0.8rem;
    }
    
    .preview-shift-block {
        padding: 10px;
        border-radius: 4px;
        color: white;
    }
</style>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Initialize modal
        const assignShiftModal = new bootstrap.Modal(document.getElementById('assignShiftModal'));
        
        // Add shift button click handler
        document.querySelectorAll('.add-shift-btn').forEach(button => {
            button.addEventListener('click', function() {
                const cell = this.closest('.schedule-cell');
                const employeeId = cell.dataset.employeeId;
                const date = cell.dataset.date;
                
                // Set form values
                document.getElementById('employee_id').value = employeeId;
                document.getElementById('date').value = date;
                
                // Reset shift selection
                document.getElementById('shift_id').value = '';
                document.querySelector('.shift-preview').style.display = 'none';
                document.getElementById('availabilityInfo').style.display = 'none';
                
                // Update modal title
                const employeeName = cell.closest('.schedule-row').querySelector('.employee-column').textContent.trim().split('\n')[0];
                document.getElementById('assignShiftModalLabel').textContent = `Assign Shift to ${employeeName} on ${date}`;
                
                // Show modal
                assignShiftModal.show();
            });
        });
        
        // Shift selection change handler for preview
        document.getElementById('shift_id').addEventListener('change', function() {
            const shiftId = this.value;
            const preview = document.querySelector('.shift-preview');
            const availabilityInfo = document.getElementById('availabilityInfo');
            
            if (shiftId) {
                const option = this.options[this.selectedIndex];
                const shiftName = option.text;
                const shiftColor = option.dataset.color;
                
                // Update preview
                preview.style.display = 'block';
                const previewBlock = preview.querySelector('.preview-shift-block');
                previewBlock.style.backgroundColor = shiftColor;
                
                // Extract shift name and time from option text
                const matchResult = shiftName.match(/(.*) \((.*) - (.*)\)/);
                if (matchResult) {
                    preview.querySelector('.preview-shift-name').textContent = matchResult[1];
                    preview.querySelector('.preview-shift-time').textContent = `${matchResult[2]} - ${matchResult[3]}`;
                } else {
                    preview.querySelector('.preview-shift-name').textContent = shiftName;
                }
                
                // Check employee availability
                checkAvailability(document.getElementById('employee_id').value, document.getElementById('date').value, shiftId);
            } else {
                preview.style.display = 'none';
                availabilityInfo.style.display = 'none';
            }
        });
        
        // Function to check employee availability
        function checkAvailability(employeeId, date, shiftId) {
            const availabilityInfo = document.getElementById('availabilityInfo');
            const availabilityMessage = document.getElementById('availabilityMessage');
            
            // This would ideally be an AJAX call to check availability
            // For now, we'll just show a generic message
            availabilityInfo.style.display = 'block';
            availabilityMessage.textContent = 'Checking availability...';
            
            // In a real implementation, you would check against the employee's availability settings
            // For now, we'll just assume they're available
            setTimeout(() => {
                availabilityInfo.className = 'alert alert-success';
                availabilityMessage.textContent = 'Employee is available for this shift.';
            }, 500);
        }
        
        // Save shift button click handler
        document.getElementById('saveShiftBtn').addEventListener('click', function() {
            const form = document.getElementById('assignShiftForm');
            const formData = new FormData(form);
            
            // Send AJAX request
            fetch('{{ url_for("assign_shift") }}', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Reload the page to show the new assignment
                    location.reload();
                } else {
                    alert('Error assigning shift: ' + data.message);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('An error occurred while assigning the shift.');
            });
        });
        
        // Remove shift button click handler
        document.querySelectorAll('.remove-shift-btn').forEach(button => {
            button.addEventListener('click', function() {
                if (confirm('Are you sure you want to remove this shift?')) {
                    const shiftBlock = this.closest('.shift-block');
                    const assignmentId = shiftBlock.dataset.assignmentId;
                    
                    const formData = new FormData();
                    formData.append('assignment_id', assignmentId);
                    
                    // Send AJAX request
                    fetch('{{ url_for("remove_shift") }}', {
                        method: 'POST',
                        body: formData
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            // Reload the page to show the changes
                            location.reload();
                        } else {
                            alert('Error removing shift: ' + data.message);
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        alert('An error occurred while removing the shift.');
                    });
                }
            });
        });
        
        // Calculate and update statistics
        updateScheduleStats();
        
        function updateScheduleStats() {
            // Count total shifts
            const totalShifts = document.querySelectorAll('.shift-block').length;
            document.getElementById('totalShifts').textContent = totalShifts;
            
            // Count scheduled employees
            const employeesWithShifts = new Set();
            document.querySelectorAll('.shift-block').forEach(shift => {
                const cell = shift.closest('.schedule-cell');
                employeesWithShifts.add(cell.dataset.employeeId);
            });
            document.getElementById('employeesScheduled').textContent = employeesWithShifts.size;
            
            // Approximate total hours (would be more accurate with actual shift durations)
            // For now, let's assume each shift is 8 hours on average
            const totalHours = totalShifts * 8;
            document.getElementById('totalHours').textContent = totalHours;
        }
    });
</script>
{% endblock %}